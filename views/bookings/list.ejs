<%- include('../partials/header', { title: 'Passenger Bookings' }) %>
<% if (typeof flash !== 'undefined' && flash) { %>
<div class="flash <%= flash.type %>"><%= flash.message %></div>
<% } %>
<h1 style="margin-bottom:1rem;">Passenger Bookings</h1>
<p><a href="/bookings/new" class="btn">New Booking</a></p>

<div class="card">
  <h3>Filter by Date Range</h3>
  <form method="get" action="/bookings" style="display:flex; gap:1rem; align-items:flex-end;">
    <div class="form-group">
      <label>From</label>
      <input type="date" name="start_date" value="<%= startDate %>">
    </div>
    <div class="form-group">
      <label>To</label>
      <input type="date" name="end_date" value="<%= endDate %>">
    </div>
    <button type="submit" class="btn">Filter</button>
    <a href="/bookings" class="btn btn-ghost">Clear</a>
  </form>
</div>

<div class="card">
  <div style="overflow-x:auto;">
  <table>
    <thead>
      <tr>
        <th>PNR</th>
        <th>Customer</th>
        <th>From → To</th>
        <th>Date</th>
        <th>Seat</th>
        <th>Operator</th>
        <th>Departure</th>
        <th>Rate fare</th>
        <th>Net fare</th>
        <th>Commission</th>
        <th>Created by</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <% bookings.forEach(function(b) { %>
      <tr data-id="<%= b.id %>">
        <td><%= b.pnr %></td>
        <td><%= b.customer_name %><br><span class="text-muted"><%= b.customer_phone %></span></td>
        <td><%= b.from_place %> → <%= b.destination %></td>
        <td><%= b.travel_date %></td>
        <td><%= b.seat_number %></td>
        <td><%= b.bus_operator %></td>
        <td><%= time12(b.departure_time) %></td>
        <td>₹<%= Number(b.total_fare).toFixed(2) %></td>
        <td>₹<%= Number(b.net_fare || b.total_fare).toFixed(2) %></td>
        <td>₹<%= Number(b.commission).toFixed(2) %></td>
        <td><%= b.created_by_name || '—' %></td>
        <td>
          <div style="display:flex; flex-direction:column; gap:0.5rem; align-items:flex-start;">
            <a href="/bookings/<%= b.id %>/part-a" class="btn btn-sm" target="_blank" style="background:#f0ad4e; color:#000;">Print Part A (Thermal)</a>
            <a href="/bookings/<%= b.id %>/edit-net" class="btn btn-sm btn-ghost">Edit net fare</a>
            <a href="/bookings/<%= b.id %>/part-b" class="btn btn-sm btn-ghost" target="_blank">Print Part B (Thermal)</a>
            <form action="/bookings/<%= b.id %>/notify-whatsapp" method="post" style="display:inline;">
              <button type="submit" class="btn btn-sm" style="background:#ffb300; color:#000;">Notify on WhatsApp</button>
            </form>
            <% if (user && user.role === 'admin') { %>
              <form action="/bookings/<%= b.id %>/delete" method="post" style="display:inline-block;" onsubmit="return confirm('Delete booking <%= b.pnr %>? This cannot be undone.')">
                <button type="submit" class="btn btn-sm" style="background:#d9534f; color:#fff;">Delete</button>
              </form>
            <% } %>
          </div>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
  </div>
</div>
  <!-- WhatsApp notifications are handled server-side to ensure correct data + optional A4 PDF attachment -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  try {
    var params = new URLSearchParams(window.location.search);
    var highlightPnr = params.get('pnr');
    if (!highlightPnr) return;
    var rows = document.querySelectorAll('table tbody tr');
    for (var i=0;i<rows.length;i++){
      var r = rows[i];
      var pnr = (r.children[0] && r.children[0].innerText) ? r.children[0].innerText.trim() : '';
      if (pnr === highlightPnr) {
        r.style.outline = '3px solid #ffd54f';
        r.scrollIntoView({behavior:'smooth', block:'center'});
        var dep = (r.children[6] && r.children[6].innerText) ? r.children[6].innerText.trim() : '';
        var seat = (r.children[4] && r.children[4].innerText) ? r.children[4].innerText.trim() : '';
        var operator = (r.children[5] && r.children[5].innerText) ? r.children[5].innerText.trim() : '';
        // modal
        var m = document.createElement('div');
        m.style.position='fixed'; m.style.inset=0; m.style.background='rgba(0,0,0,0.6)'; m.style.display='flex'; m.style.alignItems='center'; m.style.justifyContent='center'; m.style.zIndex=200;
        m.innerHTML = '<div class="card" style="min-width:300px; margin:1rem;">' +
          '<h3>Booking created: ' + highlightPnr + '</h3>' +
          '<p>' + (r.children[2]?.innerText||'') + '<br>' + (r.children[3]?.innerText||'') + '<br>Seat: ' + seat + '</p>' +
          '<div style="display:flex; gap:0.5rem;">' +
          '<button class="btn" id="_notify_booking">Notify on WhatsApp</button>' +
          '<a class="btn btn-ghost" href="/bookings/new?pnr=' + encodeURIComponent(highlightPnr) + '">New booking (keep PNR)</a>' +
          '<button class="btn btn-ghost" id="_notify_close">Close</button>' +
          '</div></div>';
        document.body.appendChild(m);
        document.getElementById('_notify_close').addEventListener('click', function(){ document.body.removeChild(m); });
        document.getElementById('_notify_booking').addEventListener('click', function(){
          var phone = (r.children[1]?.querySelector('.text-muted')?.innerText||'');
          var fromTo = (r.children[2]?.innerText||'').split('→');
          var src = (fromTo[0]||'').trim();
          var dest = (fromTo[1]||'').trim();
          var date = (r.children[3]?.innerText||'').trim();
          var id = r.dataset.id || r.getAttribute('data-id') || '';
          if (!id) return alert('Missing booking id');
          var f = document.createElement('form');
          f.method = 'post';
          f.action = '/bookings/' + encodeURIComponent(id) + '/notify-whatsapp';
          document.body.appendChild(f);
          f.submit();
        });
        break;
      }
    }
  } catch(e){}
});
</script>
  <%- include('../partials/footer') %>
